<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>画像→文字抽出ツール（体験版）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      padding: 30px;
    }
    h1 {
      text-align: center;
    }
    .box {
      background: #fff;
      max-width: 800px;
      margin: auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      cursor: crosshair;
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 15px;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-top: 15px;
    }
    .note {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>画像→文字抽出ツール（体験版）</h1>

  <div class="box">
    <input type="file" id="imageInput" accept="image/*" />
    <canvas id="canvas"></canvas>

    <div class="note">
      ・ドラッグしない場合：画像全体をOCR<br>
      ・ドラッグした場合：選択範囲のみOCR
    </div>

    <button id="ocrBtn">文字を抽出する</button>

    <textarea id="result" placeholder="ここに抽出結果が表示されます"></textarea>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const imageInput = document.getElementById("imageInput");
    const result = document.getElementById("result");

    let img = new Image();
    let startX, startY, endX, endY;
    let dragging = false;

    imageInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      img.src = URL.createObjectURL(file);
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        startX = startY = endX = endY = undefined;
      };
    });

    canvas.addEventListener("mousedown", e => {
      startX = e.offsetX;
      startY = e.offsetY;
      dragging = true;
    });

    canvas.addEventListener("mousemove", e => {
      if (!dragging) return;
      endX = e.offsetX;
      endY = e.offsetY;

      ctx.drawImage(img, 0, 0);
      ctx.strokeStyle = "red";
      ctx.lineWidth = 2;
      ctx.strokeRect(startX, startY, endX - startX, endY - startY);
    });

    canvas.addEventListener("mouseup", () => {
      dragging = false;
    });

    document.getElementById("ocrBtn").addEventListener("click", () => {
      if (!img.src) {
        alert("画像を選択してください");
        return;
      }

      let targetCanvas = canvas;

      if (startX !== undefined && endX !== undefined) {
        const w = Math.abs(endX - startX);
        const h = Math.abs(endY - startY);

        if (w > 5 && h > 5) {
          const crop = document.createElement("canvas");
          crop.width = w;
          crop.height = h;
          crop.getContext("2d").drawImage(
            canvas,
            Math.min(startX, endX),
            Math.min(startY, endY),
            w,
            h,
            0,
            0,
            w,
            h
          );
          targetCanvas = crop;
        }
      }

      const base64 = targetCanvas.toDataURL("image/png").split(",")[1];
      result.value = "OCR中…";

      fetch("https://ocr-proxy-773716506088.asia-northeast1.run.app/ocr", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: base64 })
      })
      .then(r => r.json())
      .then(d => {
        result.value = d.text || "（文字が検出されませんでした）";
      })
      .catch(err => {
        result.value = "エラーが発生しました";
        console.error(err);
      });
    });
  </script>
</body>
</html>
